Description: Fixes: CVE-2016-8745: When unable to complete sendfile request,
 ensure the Processor will be added to the cache only once.
 This bug in the error handling of the send file code for the NIO HTTP connector
 resulted in the current Processor object being added to the Processor cache
 multiple times. This in turn meant that the same Processor could be used for
 concurrent requests. Sharing a Processor can result in information leakage
 between requests including, not not limited to, session ID and the response
 body.
Origin: backport, https://svn.apache.org/r1777469 13f79535-47bb-0310-9956-ffa450edef68
Bug: https://bz.apache.org/bugzilla/show_bug.cgi?id=60409
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -1251,11 +1251,15 @@
                 }
             }catch ( IOException x ) {
                 if ( log.isDebugEnabled() ) log.debug("Unable to complete sendfile request:", x);
-                cancelledKey(sk,SocketStatus.ERROR);
+                if (!event) {
+                    cancelledKey(sk,SocketStatus.ERROR);
+                }
                 return false;
             }catch ( Throwable t ) {
                 log.error("",t);
-                cancelledKey(sk, SocketStatus.ERROR);
+                if (!event) {
+                    cancelledKey(sk, SocketStatus.ERROR);
+                }
                 return false;
             }finally {
                 if (sc!=null) sc.setSendFile(false);
