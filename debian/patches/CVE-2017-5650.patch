From: Markus Koschany <apo@debian.org>
Date: Wed, 12 Apr 2017 00:00:50 +0200
Subject: CVE-2017-5650

Bug-Debian: https://bugs.debian.org/860068
Origin: http://svn.apache.org/r1788480
---
 java/org/apache/coyote/http2/Http2UpgradeHandler.java | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/java/org/apache/coyote/http2/Http2UpgradeHandler.java b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
index 03c5c25..0d7d9d5 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -983,6 +983,11 @@ public class Http2UpgradeHandler extends AbstractStream implements InternalHttpU
 
     private void close() {
         connectionState.set(ConnectionState.CLOSED);
+        for (Stream stream : streams.values()) {
+            // The connection is closing. Close the associated streams as no
+            // longer required.
+            stream.receiveReset(Http2Error.CANCEL.getCode());
+        }
         try {
             socketWrapper.close();
         } catch (IOException ioe) {
